  升级版推送
  我们调研到在电销转化监控、续报监控 、预约到课监控、行课监控等场景下，需要业务人员手动编辑报表，生成图片，每隔一段时间，人工发送图片到不同的业务钉钉群，让相关人员及时获取业务情况进展，进行接下来的业务动作。
  为了更便捷的给用户提供数据，解放人工推送的重复工作，我们推出了按照用户配置的时间点，钉钉群给用户推送图片数据
   
  升级版推送功能描述
  需求描述：
  用户可以以现有看板为模型创建一个推送看板，并设置推送消息（标题，备注，推送时间，推送群等），用户设置完成之后，无需任何操作，便可以自动给用户设置的群，定时推送看板的图片（这个图片是动态数据，一般会显示推送时间点的数据）
   难点：
  用户设置之后不需要在做任何操作就能完成之后的一切，那么我们需要定时的去打开配置的看板的页面，然后截图上传供后端用来推送。当然这个过程肯定不能手动去做，那只有考虑写脚本完成，怎么用js实现一直保持页面打开并且不断的触发查询，截图上传呢？思考了很久也没找到方式，后来考虑能不能用node服务去完成，然后在社区搜索，终于找到了puppeteer ！！！
  puppeteer是谷歌发布的一个Node包，用来模拟 Chrome 浏览器的运行。那我们是不是可以搭建一个node服务，通过puppeteer+node-cron来实现我们的需求
  实现：
  - 启动一个node服务，引入puppeteer
  - 引入任务调度，轮询后端推送配置接口，对当前时间点需要推送看板使用headless浏览器打开，截图，上传，推送
  - redius加锁，因为node服务存在多台服务器，后台服务端也存在多台服务器，我们需要指控当前时间点的推送列表只返回给一个服务器，当一个服务器知道这个推送已经被其余服务器处理之后，不再处理
   优化：
  - 失败补偿 - 本次推送失败后，自动重新推送
   当然这一步主要由后端完成，后端设计一个推送状态机，主要分为接受前端截图--上传截图---拿到截图推送至群--成功完成。其中前两个步骤如果失败，本次推送会再次被加入推送配置队列，第三个步骤失败，后端会尝试重新推送到钉钉群。
[图片]
   
  - 错误检查 - 数据为空时，不推送
    遇到问题及解决方案
  在续报推送的时候会出现英语的报表推成了数学的这种张冠李戴的问题？
  问题定位：node端读取推送配置看板数组，对数组进行并发截图推送，然而后端采用毫秒时间命名图片，如果出现不同的两个报表在同一毫秒完成截图就会由于命名原因出现图片覆盖的情况
  解决方法：后端修改图片命名规则
  截图不全甚至出现空数据
  解决方案：
  - page.goto(url[, options])，
  修改options配置waitUntil=networkidle0，当没有网络请求的时候算跳转成功
[图片]
   
  - 取dom中的loading的div是否存在，如果存在loading, 则跳过截图，后端收不到该id下的图片会认为该任务未完成，继续在配置接口中返回，尝试重新截图
  - 分析出现空数据的根本原因，既然已经设置了waitUntil为没有网络请求的时机截图，那还是截图不全是由于前端的渲染问题吗？按理说不应该，因为数据量并不大，后边发现根本原因在presto数据查询引擎的问题，由于最开始我们是多个看板并发打开的，一个看板下又存在多个图表，会造成大量的数据请求同时到达presto, 出现排队严重问题，造成数据无法及时返回，所以我们控制并发看板打开，采用promsie并发控制（tiny-async-pool），每次只处理一个看板，缓解presto排队问题。
  
   
   